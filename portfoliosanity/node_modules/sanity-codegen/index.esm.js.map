{"version":3,"file":"index.esm.js","sources":["../src/client/create-client.ts"],"sourcesContent":["import { SanityReference, SanityKeyedReference } from '../types';\n\ninterface CreateClientOptions {\n  projectId: string;\n  dataset: string;\n  fetch: WindowOrWorkerGlobalScope['fetch'];\n  token?: string;\n  previewMode?: boolean;\n  useCdn?: boolean;\n  apiVersion?: string;\n}\n\ninterface SanityResult<T> {\n  ms: number;\n  query: string;\n  result: T[];\n}\n\nfunction createClient<Documents extends { _type: string; _id: string }>({\n  dataset,\n  projectId,\n  token,\n  previewMode: _previewMode = false,\n  apiVersion = '1',\n  fetch,\n  useCdn,\n}: CreateClientOptions) {\n  const normalizedApiVersion = normalizeApiVersion(apiVersion);\n  const previewModeRef = { current: _previewMode };\n\n  function normalizeApiVersion(version: string): string {\n    const [firstChar] = version;\n    if (firstChar === \"v\") {\n      return version.slice(1);\n    }\n\n    return version;\n  }\n\n  async function jsonFetch<T>(url: RequestInfo, options?: RequestInit) {\n    const response = await fetch(url, {\n      ...options,\n      headers: {\n        Accept: 'application/json',\n        ...options?.headers,\n      },\n    });\n    return (await response.json()) as T;\n  }\n\n  /**\n   * Given a type string and a document ID, this function returns a typed\n   * version of that document.\n   *\n   * If previewMode is true and a token is provided, then the client will prefer\n   * drafts over the published version.\n   */\n  async function get<T extends Documents['_type']>(\n    // NOTE: type is exclusively for typescript, it's not actually used in code\n    _type: T,\n    id: string\n  ) {\n    type R = Documents & { _type: T };\n\n    const preview = previewModeRef.current && !!token;\n    const previewClause = preview\n      ? // sanity creates a new document with an _id prefix of `drafts.`\n      // for when a document is edited without being published\n      `|| _id==\"drafts.${id}\"`\n      : '';\n\n    const [result] = await query<R>(`* [_id == \"${id}\" ${previewClause}]`);\n    return result;\n  }\n\n  /**\n   * Gets all the documents of a particular type. In preview mode, if a document\n   * has a draft, that will be returned instead.\n   */\n  async function getAll<T extends Documents['_type']>(\n    type: T,\n    filterClause?: string\n  ) {\n    // force typescript to narrow the type using the intersection.\n    // TODO: might be a cleaner way to do this. this creates an ugly lookin type\n    type R = { _type: T } & Documents;\n\n    return await query<R>(\n      `* [_type == \"${type}\"${filterClause ? ` && ${filterClause}` : ''}]`\n    );\n  }\n\n  /**\n   * If a sanity document refers to another sanity document, then you can use this\n   * function to expand that document, preserving the type\n   */\n  async function expand<T extends Documents>(\n    ref: SanityReference<T> | SanityKeyedReference<T>\n  ) {\n    // this function is primarily for typescript\n    const response = await get<T['_type']>(null as any, ref._ref);\n    // since this is a ref, the response will be defined (unless weak reference)\n    return response!;\n  }\n\n  /**\n   * Passes a query along to sanity. If preview mode is active and a token is\n   * present, it will prefer drafts over the published versions.\n   */\n  async function query<T extends { _id: string } = any>(\n    query: string\n  ): Promise<T[]> {\n    const searchParams = new URLSearchParams();\n    const preview = previewModeRef.current && !!token;\n\n    searchParams.set('query', query);\n    const response = await jsonFetch<SanityResult<T>>(\n      `https://${projectId}.${\n        useCdn ? 'apicdn' : 'api'\n      }.sanity.io/v${normalizedApiVersion}/data/query/${dataset}?${searchParams.toString()}`,\n      {\n        // conditionally add the authorization header if the token is present\n        ...(token &&\n          !useCdn && { headers: { Authorization: `Bearer ${token}` } }),\n      }\n    );\n\n    const prefix = 'drafts.';\n\n    if (!preview) {\n      return response.result.filter((doc) => !doc._id.startsWith(prefix));\n    }\n\n    const removeDraftPrefix = (_id: string) =>\n      _id.startsWith(prefix) ? _id.substring(prefix.length) : _id;\n\n    // create a lookup of only draft docs\n    const draftDocs = response.result\n      .filter((doc) => doc._id.startsWith('drafts.'))\n      .reduce<{ [_id: string]: T }>((acc, next) => {\n        acc[removeDraftPrefix(next._id)] = next;\n        return acc;\n      }, {});\n\n    // in this dictionary, if there is draft doc, that will be preferred,\n    // otherwise it'll use the published version\n    const finalAcc = response.result.reduce<{ [_id: string]: T }>(\n      (acc, next) => {\n        const id = removeDraftPrefix(next._id);\n        acc[id] = draftDocs[id] || next;\n        return acc;\n      },\n      {}\n    );\n\n    return Object.values(finalAcc);\n  }\n\n  /**\n   * Flip whether or not this client is using preview mode or not. Useful for\n   * preview mode within next.js.\n   */\n  function setPreviewMode(previewMode: boolean) {\n    previewModeRef.current = previewMode;\n  }\n\n  return { get, getAll, expand, query, setPreviewMode };\n}\n\nexport default createClient;\n"],"names":["createClient","dataset","projectId","token","previewMode","_previewMode","apiVersion","fetch","useCdn","normalizedApiVersion","normalizeApiVersion","previewModeRef","current","version","firstChar","slice","jsonFetch","url","options","response","headers","Accept","json","get","_type","id","preview","previewClause","result","query","getAll","type","filterClause","expand","ref","_ref","searchParams","URLSearchParams","set","toString","Authorization","prefix","filter","doc","_id","startsWith","removeDraftPrefix","substring","length","draftDocs","reduce","acc","next","finalAcc","Object","values","setPreviewMode"],"mappings":"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"}